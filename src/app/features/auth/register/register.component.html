<div class="registrar-container">
  <div class="registrar-card">
    <!-- Header com Logo -->
    <div class="registrar-header">
      <div class="logo">
        <img src="assets/images/logo/logo5.png" alt="Logo ALLTURISMO" class="logo-image">
        <span class="logo-text" aria-hidden="true">ALLTURISMO</span>
      </div>
      <div class="header-content">
        <h3 class="subtitle" aria-label="Seja um parceiro">SEJA UM PARCEIRO</h3>
        <h2 class="title" id="step-title" aria-live="polite">{{ stepTitle }}</h2>
      </div>
    </div>

    <!-- Mensagem de Erro -->
    <div *ngIf="showError" class="error-alert" role="alert" aria-live="assertive" aria-atomic="true" #errorAlert tabindex="-1">
      <div class="error-content">
        <div class="error-icon" aria-hidden="true">‚ö†Ô∏è</div>
        <div class="error-text">
          <h4 id="error-title">Erro no cadastro</h4>
          <!-- Exibir lista de erros se houver -->
          <div *ngIf="errorMessages.length > 0; else singleMessage">
            <ul class="error-list" aria-labelledby="error-title">
              <li *ngFor="let msg of errorMessages">{{ msg }}</li>
            </ul>
          </div>
          <!-- Exibir mensagem √∫nica se n√£o houver lista -->
          <ng-template #singleMessage>
            <p aria-describedby="error-title">{{ errorMessage }}</p>
          </ng-template>
        </div>
        <button 
          type="button" 
          class="error-close-btn" 
          (click)="hideErrorMessage()"
          (keydown.escape)="hideErrorMessage()"
          aria-label="Fechar mensagem de erro">
          √ó
        </button>
      </div>
    </div>

    <!-- Bot√µes de Debug (apenas em desenvolvimento) -->
    <div class="debug-buttons" *ngIf="!environment.production" role="group" aria-label="Bot√µes de debug">
      <button type="button" class="debug-btn" (click)="fillWithMockData()" aria-label="Preencher formul√°rio com dados de teste">
        <span aria-hidden="true">üìù</span> Preencher Mock
      </button>
      <button type="button" class="debug-btn" (click)="fillWithRandomMockData()" aria-label="Preencher formul√°rio com dados aleat√≥rios">
        <span aria-hidden="true">üé≤</span> Mock Aleat√≥rio
      </button>
    </div>

    <!-- Barra de Progresso -->
    <nav class="progress-bar" role="navigation" aria-label="Progresso do cadastro">
      <ol class="progress-list">
        <li class="progress-step" [class.active]="currentStep >= 1" [class.completed]="currentStep > 1" 
            [attr.aria-current]="currentStep === 1 ? 'step' : null">
          <div class="step-number" [attr.aria-label]="currentStep > 1 ? 'Etapa 1 conclu√≠da: Respons√°vel' : 'Etapa 1: Respons√°vel'">
            <span *ngIf="currentStep > 1" class="check-icon" aria-hidden="true">‚úì</span>
            <span *ngIf="currentStep === 1" aria-hidden="true">1</span>
          </div>
          <span class="step-text" aria-hidden="true">Respons√°vel</span>
        </li>
        <div class="progress-line" [class.completed]="currentStep > 1" aria-hidden="true"></div>
        <li class="progress-step" [class.active]="currentStep >= 2" [class.completed]="currentStep > 2"
            [attr.aria-current]="currentStep === 2 ? 'step' : null">
          <div class="step-number" [attr.aria-label]="currentStep > 2 ? 'Etapa 2 conclu√≠da: Endere√ßo' : 'Etapa 2: Endere√ßo'">
            <span *ngIf="currentStep > 2" class="check-icon" aria-hidden="true">‚úì</span>
            <span *ngIf="currentStep <= 2" aria-hidden="true">2</span>
          </div>
          <span class="step-text" aria-hidden="true">Endere√ßo</span>
        </li>
        <div class="progress-line" [class.completed]="currentStep > 2" aria-hidden="true"></div>
        <li class="progress-step" [class.active]="currentStep >= 3" [class.completed]="currentStep > 3"
            [attr.aria-current]="currentStep === 3 ? 'step' : null">
          <div class="step-number" [attr.aria-label]="currentStep > 3 ? 'Etapa 3 conclu√≠da: Estabelecimento' : 'Etapa 3: Estabelecimento'">
            <span *ngIf="currentStep > 3" class="check-icon" aria-hidden="true">‚úì</span>
            <span *ngIf="currentStep <= 3" aria-hidden="true">3</span>
          </div>
          <span class="step-text" aria-hidden="true">Estabelecimento</span>
        </li>
        <div class="progress-line" [class.completed]="currentStep > 3" aria-hidden="true"></div>
        <li class="progress-step" [class.active]="currentStep >= 4" [class.completed]="currentStep > 4"
            [attr.aria-current]="currentStep === 4 ? 'step' : null">
          <div class="step-number" [attr.aria-label]="currentStep > 4 ? 'Etapa 4 conclu√≠da: Promo√ß√£o obrigat√≥ria' : 'Etapa 4: Promo√ß√£o obrigat√≥ria'">
            <span *ngIf="currentStep > 4" class="check-icon" aria-hidden="true">‚úì</span>
            <span *ngIf="currentStep <= 4" aria-hidden="true">4</span>
          </div>
          <span class="step-text" aria-hidden="true">Promo√ß√£o obrigat√≥ria</span>
        </li>
        <div class="progress-line" [class.completed]="currentStep > 4" aria-hidden="true"></div>
        <li class="progress-step" [class.active]="currentStep >= 5" [class.completed]="currentStep > 5"
            [attr.aria-current]="currentStep === 5 ? 'step' : null">
          <div class="step-number" [attr.aria-label]="currentStep > 5 ? 'Etapa 5 conclu√≠da: Regras e informa√ß√µes' : 'Etapa 5: Regras e informa√ß√µes'">
            <span *ngIf="currentStep > 5" class="check-icon" aria-hidden="true">‚úì</span>
            <span *ngIf="currentStep <= 5" aria-hidden="true">5</span>
          </div>
          <span class="step-text" aria-hidden="true">Regras e informa√ß√µes</span>
        </li>
        <div class="progress-line" [class.completed]="currentStep > 5" aria-hidden="true"></div>
      </ol>
    </nav>

    <!-- Formul√°rio -->
    <form 
      [formGroup]="registerForm" 
      (ngSubmit)="nextStep()" 
      class="registrar-form"
      role="form"
      aria-labelledby="step-title">

      <!-- Etapa 1: Dados do Respons√°vel -->
      <div *ngIf="isStep1" class="form-step" [formGroupName]="'responsible'" role="group" aria-labelledby="step-title">
        <div class="form-group">
          <label for="name">Nome <span class="required" aria-label="campo obrigat√≥rio">*</span></label>
          <input 
            type="text" 
            id="name" 
            formControlName="name" 
            placeholder="Digite seu nome completo"
            [class.error]="responsibleForm.get('name')?.invalid && responsibleForm.get('name')?.touched"
            [attr.aria-invalid]="responsibleForm.get('name')?.invalid && responsibleForm.get('name')?.touched"
            [attr.aria-describedby]="responsibleForm.get('name')?.invalid && responsibleForm.get('name')?.touched ? 'name-error' : null"
            aria-required="true"
            autocomplete="name">
          <div 
            *ngIf="responsibleForm.get('name')?.invalid && responsibleForm.get('name')?.touched"
            class="error-message"
            id="name-error"
            role="alert"
            aria-live="polite">
            <span *ngIf="responsibleForm.get('name')?.errors?.['required']">Nome √© obrigat√≥rio</span>
            <span *ngIf="responsibleForm.get('name')?.errors?.['minlength']">Nome deve ter pelo menos 2 caracteres</span>
          </div>
        </div>

        <div class="form-group">
          <label for="email">E-mail <span class="required" aria-label="campo obrigat√≥rio">*</span></label>
          <input 
            type="email" 
            id="email" 
            formControlName="email" 
            placeholder="Digite seu e-mail"
            [class.error]="responsibleForm.get('email')?.invalid && responsibleForm.get('email')?.touched"
            [attr.aria-invalid]="responsibleForm.get('email')?.invalid && responsibleForm.get('email')?.touched"
            [attr.aria-describedby]="responsibleForm.get('email')?.invalid && responsibleForm.get('email')?.touched ? 'email-error' : null"
            aria-required="true"
            autocomplete="email">
          <div 
            *ngIf="responsibleForm.get('email')?.invalid && responsibleForm.get('email')?.touched"
            class="error-message"
            id="email-error"
            role="alert"
            aria-live="polite">
            <span *ngIf="responsibleForm.get('email')?.errors?.['required']">E-mail √© obrigat√≥rio</span>
            <span *ngIf="responsibleForm.get('email')?.errors?.['email']">E-mail inv√°lido</span>
          </div>
        </div>

        <div class="form-group">
          <label for="password">Senha <span class="required" aria-label="campo obrigat√≥rio">*</span></label>
          <input 
            type="password" 
            id="password" 
            formControlName="password" 
            placeholder="Senha para acessar a plataforma"
            [class.error]="responsibleForm.get('password')?.invalid && responsibleForm.get('password')?.touched"
            [attr.aria-invalid]="responsibleForm.get('password')?.invalid && responsibleForm.get('password')?.touched"
            [attr.aria-describedby]="responsibleForm.get('password')?.invalid && responsibleForm.get('password')?.touched ? 'password-error' : 'password-hint'"
            aria-required="true"
            autocomplete="new-password">
          <span id="password-hint" class="sr-only">M√≠nimo de 6 caracteres</span>
          <div 
            *ngIf="responsibleForm.get('password')?.invalid && responsibleForm.get('password')?.touched"
            class="error-message"
            id="password-error"
            role="alert"
            aria-live="polite">
            <span *ngIf="responsibleForm.get('password')?.errors?.['required']">Senha √© obrigat√≥ria</span>
            <span *ngIf="responsibleForm.get('password')?.errors?.['minlength']">Senha deve ter pelo menos 6 caracteres</span>
          </div>
        </div>

        <div class="form-group">
          <label for="confirmPassword">Confirma√ß√£o da senha <span class="required" aria-label="campo obrigat√≥rio">*</span></label>
          <input 
            type="password" 
            id="confirmPassword" 
            formControlName="confirmPassword"
            placeholder="Repita a senha cadastrada"
            [class.error]="((responsibleForm.get('confirmPassword')?.invalid || responsibleForm.hasError('passwordMismatch')) && responsibleForm.get('confirmPassword')?.touched)"
            [attr.aria-invalid]="((responsibleForm.get('confirmPassword')?.invalid || responsibleForm.hasError('passwordMismatch')) && responsibleForm.get('confirmPassword')?.touched)"
            [attr.aria-describedby]="responsibleForm.get('confirmPassword')?.touched && (responsibleForm.get('confirmPassword')?.invalid || responsibleForm.hasError('passwordMismatch')) ? 'confirmPassword-error' : null"
            aria-required="true"
            autocomplete="new-password">
          <div 
            *ngIf="responsibleForm.get('confirmPassword')?.touched" 
            class="error-message"
            id="confirmPassword-error"
            role="alert"
            aria-live="polite">
            <span *ngIf="responsibleForm.get('confirmPassword')?.errors?.['required']">Confirma√ß√£o da senha √© obrigat√≥ria</span>
            <span *ngIf="!responsibleForm.get('confirmPassword')?.errors?.['required'] && responsibleForm.hasError('passwordMismatch')">As senhas n√£o conferem</span>
          </div>
        </div>

        <div class="form-group">
          <label for="phone">WhatsApp <span class="required" aria-label="campo obrigat√≥rio">*</span></label>
          <input 
            type="tel" 
            id="phone" 
            formControlName="phone" 
            (input)="formatPhone($event)"
            (keypress)="validateNumbersOnly($event)" 
            placeholder="(XX) XXXXX-XXXX" 
            maxlength="15"
            [class.error]="responsibleForm.get('phone')?.invalid && responsibleForm.get('phone')?.touched"
            [attr.aria-invalid]="responsibleForm.get('phone')?.invalid && responsibleForm.get('phone')?.touched"
            [attr.aria-describedby]="responsibleForm.get('phone')?.invalid && responsibleForm.get('phone')?.touched ? 'phone-error' : null"
            aria-required="true"
            autocomplete="tel">
          <div 
            *ngIf="responsibleForm.get('phone')?.invalid && responsibleForm.get('phone')?.touched"
            class="error-message"
            id="phone-error"
            role="alert"
            aria-live="polite">
            <span *ngIf="responsibleForm.get('phone')?.errors?.['required']">WhatsApp √© obrigat√≥rio</span>
            <span *ngIf="responsibleForm.get('phone')?.errors?.['minlength']">WhatsApp deve ter pelo menos 14 caracteres</span>
          </div>
        </div>
      </div>

      <!-- Etapa 2: Endere√ßo -->
      <div *ngIf="isStep2" class="form-step" [formGroupName]="'address'" role="group" aria-labelledby="step-title">
        <div class="form-group">
          <label for="cep">CEP <span class="required" aria-label="campo obrigat√≥rio">*</span></label>
          <div class="cep-input-container">
            <input 
              type="text" 
              id="cep" 
              formControlName="cep" 
              (input)="formatCep($event)"
              (keypress)="validateNumbersOnly($event)" 
              placeholder="00000-000" 
              maxlength="9"
              [class.error]="addressForm.get('cep')?.invalid && addressForm.get('cep')?.touched"
              [disabled]="isConsultingCep"
              [attr.aria-invalid]="addressForm.get('cep')?.invalid && addressForm.get('cep')?.touched"
              [attr.aria-describedby]="addressForm.get('cep')?.invalid && addressForm.get('cep')?.touched ? 'cep-error' : (isConsultingCep ? 'cep-loading' : null)"
              [attr.aria-busy]="isConsultingCep"
              aria-required="true"
              autocomplete="postal-code">
            <div *ngIf="isConsultingCep" class="cep-loading" id="cep-loading" role="status" aria-live="polite">
              <span>Consultando CEP...</span>
            </div>
          </div>
          <div 
            *ngIf="addressForm.get('cep')?.invalid && addressForm.get('cep')?.touched" 
            class="error-message"
            id="cep-error"
            role="alert"
            aria-live="polite">
            <span *ngIf="addressForm.get('cep')?.errors?.['required']">CEP √© obrigat√≥rio</span>
            <span *ngIf="addressForm.get('cep')?.errors?.['minlength']">CEP deve ter pelo menos 8 caracteres</span>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="state">Estado <span class="required" aria-label="campo obrigat√≥rio">*</span></label>
            <input 
              type="text" 
              id="state" 
              formControlName="state" 
              placeholder="Digite o estado"
              [class.error]="addressForm.get('state')?.invalid && addressForm.get('state')?.touched"
              [attr.aria-invalid]="addressForm.get('state')?.invalid && addressForm.get('state')?.touched"
              [attr.aria-describedby]="addressForm.get('state')?.invalid && addressForm.get('state')?.touched ? 'state-error' : null"
              aria-required="true"
              autocomplete="address-level1">
            <div 
              *ngIf="addressForm.get('state')?.invalid && addressForm.get('state')?.touched" 
              class="error-message"
              id="state-error"
              role="alert"
              aria-live="polite">
              <span *ngIf="addressForm.get('state')?.errors?.['required']">Estado √© obrigat√≥rio</span>
            </div>
          </div>

          <div class="form-group">
            <label for="city">Cidade <span class="required" aria-label="campo obrigat√≥rio">*</span></label>
            <input 
              type="text" 
              id="city" 
              formControlName="city" 
              placeholder="Digite a cidade"
              [class.error]="addressForm.get('city')?.invalid && addressForm.get('city')?.touched"
              [attr.aria-invalid]="addressForm.get('city')?.invalid && addressForm.get('city')?.touched"
              [attr.aria-describedby]="addressForm.get('city')?.invalid && addressForm.get('city')?.touched ? 'city-error' : null"
              aria-required="true"
              autocomplete="address-level2">
            <div 
              *ngIf="addressForm.get('city')?.invalid && addressForm.get('city')?.touched" 
              class="error-message"
              id="city-error"
              role="alert"
              aria-live="polite">
              <span *ngIf="addressForm.get('city')?.errors?.['required']">Cidade √© obrigat√≥ria</span>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label for="neighborhood">Bairro <span class="required" aria-label="campo obrigat√≥rio">*</span></label>
          <input 
            type="text" 
            id="neighborhood" 
            formControlName="neighborhood" 
            placeholder="Digite o bairro"
            [class.error]="addressForm.get('neighborhood')?.invalid && addressForm.get('neighborhood')?.touched"
            [attr.aria-invalid]="addressForm.get('neighborhood')?.invalid && addressForm.get('neighborhood')?.touched"
            [attr.aria-describedby]="addressForm.get('neighborhood')?.invalid && addressForm.get('neighborhood')?.touched ? 'neighborhood-error' : null"
            aria-required="true">
          <div 
            *ngIf="addressForm.get('neighborhood')?.invalid && addressForm.get('neighborhood')?.touched"
            class="error-message"
            id="neighborhood-error"
            role="alert"
            aria-live="polite">
            <span *ngIf="addressForm.get('neighborhood')?.errors?.['required']">Bairro √© obrigat√≥rio</span>
          </div>
        </div>

        <div class="form-group">
          <label for="street">Rua/Avenida <span class="required" aria-label="campo obrigat√≥rio">*</span></label>
          <input 
            type="text" 
            id="street" 
            formControlName="street" 
            placeholder="Digite a rua ou avenida"
            [class.error]="addressForm.get('street')?.invalid && addressForm.get('street')?.touched"
            [attr.aria-invalid]="addressForm.get('street')?.invalid && addressForm.get('street')?.touched"
            [attr.aria-describedby]="addressForm.get('street')?.invalid && addressForm.get('street')?.touched ? 'street-error' : null"
            aria-required="true"
            autocomplete="address-line1">
          <div 
            *ngIf="addressForm.get('street')?.invalid && addressForm.get('street')?.touched" 
            class="error-message"
            id="street-error"
            role="alert"
            aria-live="polite">
            <span *ngIf="addressForm.get('street')?.errors?.['required']">Rua/Avenida √© obrigat√≥ria</span>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="number">N√∫mero <span class="required" aria-label="campo obrigat√≥rio">*</span></label>
            <input 
              type="text" 
              id="number" 
              formControlName="number" 
              placeholder="Digite o n√∫mero"
              [class.error]="addressForm.get('number')?.invalid && addressForm.get('number')?.touched"
              [attr.aria-invalid]="addressForm.get('number')?.invalid && addressForm.get('number')?.touched"
              [attr.aria-describedby]="addressForm.get('number')?.invalid && addressForm.get('number')?.touched ? 'number-error' : null"
              aria-required="true">
            <div 
              *ngIf="addressForm.get('number')?.invalid && addressForm.get('number')?.touched" 
              class="error-message"
              id="number-error"
              role="alert"
              aria-live="polite">
              <span *ngIf="addressForm.get('number')?.errors?.['required']">N√∫mero √© obrigat√≥rio</span>
            </div>
          </div>

          <div class="form-group">
            <label for="complement">Complemento (opcional)</label>
            <input 
              type="text" 
              id="complement" 
              formControlName="complement" 
              placeholder="Digite o complemento"
              aria-label="Complemento do endere√ßo (campo opcional)"
              autocomplete="address-line2">
          </div>
        </div>
      </div>

      <!-- Etapa 3: Estabelecimento -->
      <div *ngIf="isStep3" class="form-step" [formGroupName]="'establishment'" role="group" aria-labelledby="step-title">
        <div class="form-group">
          <label for="establishmentName">Nome do estabelecimento (como aparecer√° no app) <span class="required" aria-label="campo obrigat√≥rio">*</span></label>
          <input 
            type="text" 
            id="establishmentName" 
            formControlName="name" 
            placeholder="Ex.: Pizzaria Bela Massas"
            [class.error]="establishmentForm.get('name')?.invalid && establishmentForm.get('name')?.touched"
            [attr.aria-invalid]="establishmentForm.get('name')?.invalid && establishmentForm.get('name')?.touched"
            [attr.aria-describedby]="establishmentForm.get('name')?.invalid && establishmentForm.get('name')?.touched ? 'establishmentName-error' : null"
            aria-required="true"
            autocomplete="organization">
          <div 
            *ngIf="establishmentForm.get('name')?.invalid && establishmentForm.get('name')?.touched"
            class="error-message"
            id="establishmentName-error"
            role="alert"
            aria-live="polite">
            <span *ngIf="establishmentForm.get('name')?.errors?.['required']">Nome do estabelecimento √© obrigat√≥rio</span>
            <span *ngIf="establishmentForm.get('name')?.errors?.['minlength']">Nome deve ter pelo menos 2 caracteres</span>
          </div>
        </div>

        <div class="form-group">
          <label for="cnpj">CNPJ <span class="required" aria-label="campo obrigat√≥rio">*</span></label>
          <input 
            type="text" 
            id="cnpj" 
            formControlName="cnpj" 
            (input)="formatCnpj($event)"
            (keypress)="validateNumbersOnly($event)" 
            placeholder="00.000.000/0001-00" 
            maxlength="18"
            [class.error]="establishmentForm.get('cnpj')?.invalid && establishmentForm.get('cnpj')?.touched"
            [attr.aria-invalid]="establishmentForm.get('cnpj')?.invalid && establishmentForm.get('cnpj')?.touched"
            [attr.aria-describedby]="establishmentForm.get('cnpj')?.invalid && establishmentForm.get('cnpj')?.touched ? 'cnpj-error' : null"
            aria-required="true">
          <div 
            *ngIf="establishmentForm.get('cnpj')?.invalid && establishmentForm.get('cnpj')?.touched"
            class="error-message"
            id="cnpj-error"
            role="alert"
            aria-live="polite">
            <span *ngIf="establishmentForm.get('cnpj')?.errors?.['required']">CNPJ √© obrigat√≥rio</span>
            <span *ngIf="establishmentForm.get('cnpj')?.errors?.['minlength']">CNPJ deve ter pelo menos 18 caracteres</span>
            <span *ngIf="establishmentForm.get('cnpj')?.errors?.['invalidCnpj']">CNPJ inv√°lido</span>
          </div>
        </div>

        <fieldset class="category-grid" role="radiogroup" aria-labelledby="category-label" aria-required="true">
          <legend id="category-label" class="sr-only">Selecione a categoria do estabelecimento</legend>
          <div *ngFor="let category of categories" class="category-option"
            [class.selected]="establishmentForm.get('categoryId')?.value === category.id"
            (click)="establishmentForm.patchValue({categoryId: category.id}); onCategoryChange(category.id)"
            (keydown.enter)="establishmentForm.patchValue({categoryId: category.id}); onCategoryChange(category.id); $event.preventDefault()"
            (keydown.space)="establishmentForm.patchValue({categoryId: category.id}); onCategoryChange(category.id); $event.preventDefault()"
            tabindex="0"
            role="radio"
            [attr.aria-checked]="establishmentForm.get('categoryId')?.value === category.id">
            <input 
              type="radio" 
              [id]="'category-' + category.id" 
              name="categoryId" 
              [value]="category.id"
              formControlName="categoryId"
              tabindex="-1"
              [attr.aria-label]="category.name">
            <label [for]="'category-' + category.id" aria-hidden="true">{{ category.name }}</label>
          </div>
        </fieldset>

        <div 
          *ngIf="establishmentForm.get('categoryId')?.invalid && establishmentForm.get('categoryId')?.touched"
          class="error-message"
          id="category-error"
          role="alert"
          aria-live="polite">
          <span *ngIf="establishmentForm.get('categoryId')?.errors?.['required']">Categoria √© obrigat√≥ria</span>
        </div>

        <div class="form-group">
          <label for="subcategory">Subcategoria <span class="required" aria-label="campo obrigat√≥rio">*</span></label>
          <select 
            id="subcategory" 
            formControlName="subcategoryId"
            [class.error]="establishmentForm.get('subcategoryId')?.invalid && establishmentForm.get('subcategoryId')?.touched"
            [attr.aria-invalid]="establishmentForm.get('subcategoryId')?.invalid && establishmentForm.get('subcategoryId')?.touched"
            [attr.aria-describedby]="establishmentForm.get('subcategoryId')?.invalid && establishmentForm.get('subcategoryId')?.touched ? 'subcategory-error' : null"
            aria-required="true">
            <option value="">Selecione uma subcategoria</option>
            <option *ngFor="let subcategory of subcategories" [value]="subcategory.id">
              {{ subcategory.name }}
            </option>
          </select>
          <div
            *ngIf="establishmentForm.get('subcategoryId')?.invalid && establishmentForm.get('subcategoryId')?.touched"
            class="error-message"
            id="subcategory-error"
            role="alert"
            aria-live="polite">
            <span *ngIf="establishmentForm.get('subcategoryId')?.errors?.['required']">Subcategoria √© obrigat√≥ria</span>
          </div>
        </div>

        <div *ngIf="canShowDeliveryOption()" class="form-group mb-8">
          <fieldset>
            <legend class="section-title mb-2">Servi√ßo de delivery</legend>
            <label class="flex items-center space-x-3">
              <input 
                type="checkbox" 
                id="hasDelivery" 
                formControlName="has_delivery"
                class="w-5 h-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                aria-describedby="delivery-hint" />
              <span class="text-gray-700 font-medium">Oferece servi√ßo de delivery</span>
            </label>
            <span id="delivery-hint" class="sr-only">Marque se o estabelecimento oferece servi√ßo de entrega</span>
          </fieldset>
        </div>

        <div class="form-group">
          <fieldset>
            <legend class="section-title">Meios de contato</legend>
            <p class="section-subtitle" id="contact-hint">Ficar√£o vis√≠veis em seu perfil no app.</p>

            <div class="form-group">
              <label for="establishmentPhone">Telefone/WhatsApp <span class="required" aria-label="campo obrigat√≥rio">*</span></label>
              <input 
                type="tel" 
                id="establishmentPhone" 
                formControlName="phone" 
                (input)="formatEstablishmentPhone($event)"
                (keypress)="validateNumbersOnly($event)" 
                placeholder="(XX) XXXXX-XXXX" 
                maxlength="15"
                [class.error]="establishmentForm.get('phone')?.invalid && establishmentForm.get('phone')?.touched"
                [attr.aria-invalid]="establishmentForm.get('phone')?.invalid && establishmentForm.get('phone')?.touched"
                [attr.aria-describedby]="establishmentForm.get('phone')?.invalid && establishmentForm.get('phone')?.touched ? 'establishmentPhone-error' : 'contact-hint'"
                aria-required="true"
                autocomplete="tel">
              <div 
                *ngIf="establishmentForm.get('phone')?.invalid && establishmentForm.get('phone')?.touched"
                class="error-message"
                id="establishmentPhone-error"
                role="alert"
                aria-live="polite">
                <span *ngIf="establishmentForm.get('phone')?.errors?.['required']">Telefone/WhatsApp √© obrigat√≥rio</span>
                <span *ngIf="establishmentForm.get('phone')?.errors?.['minlength']">Telefone deve ter pelo menos 14 caracteres</span>
              </div>
            </div>

            <div class="form-group">
              <label for="instagram">Instagram (opcional)</label>
              <input 
                type="url" 
                id="instagram" 
                formControlName="instagram" 
                placeholder="Insira o link do seu perfil"
                aria-label="Link do perfil do Instagram (campo opcional)"
                autocomplete="url">
            </div>
          </fieldset>
        </div>

        <div class="form-group">
          <label for="description">Descreva a atividade do estabelecimento <span class="required" aria-label="campo obrigat√≥rio">*</span></label>
          <textarea 
            id="description" 
            formControlName="description" 
            placeholder="Ex.: Bar especializado em petiscos."
            maxlength="100" 
            rows="4"
            [class.error]="establishmentForm.get('description')?.invalid && establishmentForm.get('description')?.touched"
            [attr.aria-invalid]="establishmentForm.get('description')?.invalid && establishmentForm.get('description')?.touched"
            [attr.aria-describedby]="establishmentForm.get('description')?.invalid && establishmentForm.get('description')?.touched ? 'description-error' : 'description-counter'"
            aria-required="true"></textarea>
          <div class="char-counter" id="description-counter" aria-live="polite" aria-atomic="true">
            {{ establishmentForm.get('description')?.value?.length || 0 }}/100 caracteres
          </div>
          <div 
            *ngIf="establishmentForm.get('description')?.invalid && establishmentForm.get('description')?.touched"
            class="error-message"
            id="description-error"
            role="alert"
            aria-live="polite">
            <span *ngIf="establishmentForm.get('description')?.errors?.['maxlength']">Descri√ß√£o deve ter no m√°ximo 100 caracteres</span>
          </div>
        </div>

        <div class="form-group">
          <label class="section-title" id="logo-label">Logo <span class="required" aria-label="campo obrigat√≥rio">*</span></label>
          <p class="section-subtitle" id="logo-hint">Envie a logo do seu estabelecimento.</p>

          <div class="logo-upload-area"
            [class.error]="(establishmentForm.get('logoFile')?.invalid && establishmentForm.get('logoFile')?.touched) || logoUploadError"
            [class.uploading]="isUploadingLogo"
            role="group"
            aria-labelledby="logo-label"
            [attr.aria-describedby]="logoUploadError ? 'logo-upload-error' : (establishmentForm.get('logoFile')?.invalid && establishmentForm.get('logoFile')?.touched ? 'logo-error' : 'logo-hint')">
            
            <div *ngIf="isUploadingLogo" class="upload-loading" role="status" aria-live="polite">
              <span class="loading-spinner"></span>
              <span>Enviando logo...</span>
            </div>

            <div class="upload-placeholder" *ngIf="!isUploadingLogo">
              <input 
                type="file" 
                id="logoFile" 
                accept="image/*" 
                (change)="onLogoSelected($event)" 
                style="display: none;"
                aria-label="Selecionar arquivo de logo do estabelecimento"
                aria-required="true"
                #fileInput>
              <div class="upload-icon" aria-hidden="true">‚Üë</div>
              <button 
                type="button" 
                class="upload-btn" 
                (click)="fileInput.click()"
                (keydown.enter)="fileInput.click(); $event.preventDefault()"
                (keydown.space)="fileInput.click(); $event.preventDefault()"
                aria-label="Selecionar imagem da logo"
                [attr.aria-describedby]="'logo-hint'">
                Selecionar imagem
              </button>
            </div>

            <div *ngIf="establishmentForm.get('logoPreview')?.value && !isUploadingLogo" class="logo-preview" role="img" aria-label="Preview da logo selecionada">
              <img [src]="establishmentForm.get('logoPreview')?.value" alt="Preview da logo do estabelecimento" class="preview-image">
              <button 
                type="button" 
                class="remove-btn" 
                (click)="removeLogo()"
                (keydown.enter)="removeLogo(); $event.preventDefault()"
                (keydown.space)="removeLogo(); $event.preventDefault()"
                aria-label="Remover logo selecionada">
                Remover
              </button>
            </div>

            <div *ngIf="logoUploadError" class="upload-error-message" id="logo-upload-error" role="alert" aria-live="assertive">
              <mat-icon class="error-icon" aria-hidden="true">error</mat-icon>
              <span>{{ logoUploadError }}</span>
            </div>

            <div 
              *ngIf="!logoUploadError && establishmentForm.get('logoFile')?.invalid && establishmentForm.get('logoFile')?.touched"
              class="error-message"
              id="logo-error"
              role="alert"
              aria-live="polite">
              <span *ngIf="establishmentForm.get('logoFile')?.errors?.['required']">Logo √© obrigat√≥ria</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Etapa 4: Promo√ß√£o obrigat√≥ria -->
      <div *ngIf="isStep4" class="form-step" role="group" aria-labelledby="step-title">
        <!-- Se√ß√£o de Promo√ß√£o Obrigat√≥ria -->
        <div class="form-group" [formGroup]="promotionForm">
          <label class="section-title" id="promotion-label">Promo√ß√£o obrigat√≥ria</label>
          <p class="section-subtitle" id="promotion-hint">Crie uma promo√ß√£o que aparecer√° no aplicativo para atrair clientes.</p>

          <!-- Alerta informativo sobre regras da promo√ß√£o -->
          <div class="promotion-alert" role="region" aria-labelledby="promotion-rules-title">
            <div class="alert-icon" aria-hidden="true">‚ö†Ô∏è</div>
            <div class="alert-content">
              <h4 id="promotion-rules-title">Regras importantes para sua promo√ß√£o:</h4>
              <ul>
                <li><strong>Desconto m√≠nimo:</strong> Sua promo√ß√£o deve oferecer pelo menos <strong>15% de
                    desconto</strong> para ser aprovada</li>
                <li><strong>Validade:</strong> A promo√ß√£o deve ter validade enquanto durar o cadastro</li>
                <li><strong>Disponibilidade:</strong> Voc√™ deve ter estoque suficiente para atender a demanda durante
                  todo o per√≠odo da promo√ß√£o</li>
                <li><strong>Restri√ß√µes:</strong> N√£o √© permitido alterar ou cancelar a promo√ß√£o ap√≥s a aprova√ß√£o</li>
                <li><strong>Qualidade:</strong> O produto/servi√ßo promocionado deve manter a mesma qualidade padr√£o</li>
                <li><strong>Transpar√™ncia:</strong> Todas as condi√ß√µes devem estar claramente descritas no texto da
                  promo√ß√£o</li>
              </ul>
              <p class="alert-note">
                <strong>Importante:</strong> A promo√ß√£o ser√° revisada pela nossa equipe e poder√° ser rejeitada se n√£o
                atender aos crit√©rios estabelecidos.
              </p>
            </div>
          </div>

          <div class="promotion-container">
            <!-- Campo de texto da promo√ß√£o -->
            <div class="form-group">
              <label for="promotionText">Texto da promo√ß√£o <span class="required" aria-label="campo obrigat√≥rio">*</span></label>
              <textarea 
                id="promotionText" 
                formControlName="text"
                placeholder="Descreva sua promo√ß√£o especial que aparecer√° no app..." 
                maxlength="200" 
                rows="4"
                [class.error]="promotionForm.get('text')?.invalid && promotionForm.get('text')?.touched"
                class="promotion-textarea"
                [attr.aria-invalid]="promotionForm.get('text')?.invalid && promotionForm.get('text')?.touched"
                [attr.aria-describedby]="promotionForm.get('text')?.invalid && promotionForm.get('text')?.touched ? 'promotionText-error' : 'promotionText-counter'"
                aria-required="true"></textarea>
              <div class="char-counter" id="promotionText-counter" aria-live="polite" aria-atomic="true">
                {{ promotionForm.get('text')?.value?.length || 0 }}/200 caracteres
              </div>
              <div 
                *ngIf="promotionForm.get('text')?.invalid && promotionForm.get('text')?.touched"
                class="error-message"
                id="promotionText-error"
                role="alert"
                aria-live="polite">
                <span *ngIf="promotionForm.get('text')?.errors?.['required']">Texto da promo√ß√£o √© obrigat√≥rio</span>
                <span *ngIf="promotionForm.get('text')?.errors?.['minlength']">Texto deve ter pelo menos 10 caracteres</span>
                <span *ngIf="promotionForm.get('text')?.errors?.['maxlength']">Texto deve ter no m√°ximo 200 caracteres</span>
              </div>
            </div>

            <!-- Upload de fotos -->
            <div class="form-group">
              <label id="promotion-photos-label">Fotos da promo√ß√£o (m√°ximo 3) <span class="required" aria-label="campo obrigat√≥rio">*</span></label>
              <p class="section-subtitle" id="promotion-photos-hint">Adicione pelo menos 1 foto para ilustrar sua promo√ß√£o.</p>

              <div class="photos-upload-container" role="group" aria-labelledby="promotion-photos-label" aria-describedby="promotion-photos-hint">
                
                <!-- Loading indicator for promotion photos -->
                <div *ngIf="isUploadingPromotionPhotos" class="photos-upload-loading" role="status" aria-live="polite">
                  <span class="loading-spinner"></span>
                  <span>Enviando fotos...</span>
                </div>

                <!-- √Årea de upload -->
                <div class="photos-upload-area" *ngIf="promotionPhotos.length < 3 && !isUploadingPromotionPhotos">
                  <input 
                    type="file" 
                    id="promotionPhotos" 
                    accept="image/*" 
                    multiple
                    (change)="onPromotionPhotoSelected($event)" 
                    style="display: none;"
                    aria-label="Selecionar fotos da promo√ß√£o"
                    #photoInput>
                  <div 
                    class="upload-placeholder" 
                    (click)="photoInput.click()"
                    (keydown.enter)="photoInput.click(); $event.preventDefault()"
                    (keydown.space)="photoInput.click(); $event.preventDefault()"
                    tabindex="0"
                    role="button"
                    [attr.aria-label]="'Adicionar fotos da promo√ß√£o. ' + promotionPhotos.length + ' de 3 fotos adicionadas'">
                    <div class="upload-icon" aria-hidden="true">üì∑</div>
                    <span class="upload-text">Adicionar fotos</span>
                    <span class="upload-hint" aria-hidden="true">{{ promotionPhotos.length }}/3 fotos</span>
                  </div>
                </div>

                <!-- Upload errors -->
                <div *ngIf="promotionPhotosUploadErrors.length > 0" class="upload-errors-container" role="alert" aria-live="assertive">
                  <div *ngFor="let error of promotionPhotosUploadErrors" class="upload-error-message">
                    <mat-icon class="error-icon" aria-hidden="true">error</mat-icon>
                    <span>{{ error }}</span>
                  </div>
                </div>

                <!-- Preview das fotos -->
                <div class="photos-preview" *ngIf="promotionPhotos.length > 0" role="list" aria-label="Fotos da promo√ß√£o selecionadas">
                  <div *ngFor="let photo of promotionPhotos.controls; let i = index" class="photo-item" role="listitem">
                    <img [src]="photo.get('preview')?.value" [attr.alt]="'Preview da foto ' + (i + 1) + ' da promo√ß√£o'" class="photo-preview">
                    <button 
                      type="button" 
                      class="remove-photo-btn" 
                      (click)="removePromotionPhoto(i)"
                      (keydown.enter)="removePromotionPhoto(i); $event.preventDefault()"
                      (keydown.space)="removePromotionPhoto(i); $event.preventDefault()"
                      [attr.aria-label]="'Remover foto ' + (i + 1)">
                      √ó
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Se√ß√£o de Hor√°rios de Funcionamento -->
        <div class="form-group">
          <fieldset>
            <legend class="section-title">Hor√°rios de funcionamento</legend>
            <p class="section-subtitle" id="operating-hours-hint">Defina os hor√°rios de funcionamento do seu estabelecimento.</p>

            <div class="operating-hours-container" role="table" aria-label="Hor√°rios de funcionamento por dia da semana" aria-describedby="operating-hours-hint">
              <div class="operating-hours-table">
                <div *ngFor="let dayForm of operatingHoursArray.controls; let i = index" class="operating-hours-row"
                  [formGroup]="$any(dayForm)" role="row">
                  <div class="day-label" role="rowheader">
                    <span>{{ getDayLabel(dayForm.get('dayOfWeek')?.value) }}</span>
                  </div>

                  <div class="time-inputs" role="cell">
                    <label [for]="'startTime-' + i" class="sr-only">
                      Hor√°rio de abertura de {{ getDayLabel(dayForm.get('dayOfWeek')?.value) }}
                    </label>
                    <input 
                      type="text" 
                      [id]="'startTime-' + i"
                      formControlName="startTime" 
                      placeholder="09:00" 
                      maxlength="5"
                      (input)="formatTime($event)" 
                      class="time-input"
                      [attr.aria-label]="'Hor√°rio de abertura de ' + getDayLabel(dayForm.get('dayOfWeek')?.value)"
                      [attr.disabled]="dayForm.get('isClosed')?.value ? true : null">

                    <span class="time-separator" aria-hidden="true">at√©</span>

                    <label [for]="'endTime-' + i" class="sr-only">
                      Hor√°rio de fechamento de {{ getDayLabel(dayForm.get('dayOfWeek')?.value) }}
                    </label>
                    <input 
                      type="text" 
                      [id]="'endTime-' + i"
                      formControlName="endTime" 
                      placeholder="18:00" 
                      maxlength="5"
                      (input)="formatTime($event)" 
                      class="time-input"
                      [attr.aria-label]="'Hor√°rio de fechamento de ' + getDayLabel(dayForm.get('dayOfWeek')?.value)"
                      [attr.disabled]="dayForm.get('isClosed')?.value ? true : null">
                  </div>

                  <div class="closed-checkbox" role="cell">
                    <label class="checkbox-label">
                      <input 
                        type="checkbox" 
                        [id]="'isClosed-' + i"
                        [checked]="dayForm.get('isClosed')?.value"
                        (change)="onDayClosedChange(i, $any($event.target).checked)"
                        [attr.aria-label]="'Marcar ' + getDayLabel(dayForm.get('dayOfWeek')?.value) + ' como fechado'">
                      <span class="checkbox-text">Fechado</span>
                    </label>
                  </div>
                </div>
              </div>
            </div>
          </fieldset>
        </div>
      </div>

      <!-- Etapa 5: Regras e Informa√ß√µes -->
      <div *ngIf="isStep5" class="form-step" [formGroupName]="'additionalInfo'" role="group" aria-labelledby="step-title">
        <div class="form-group">
          <fieldset>
            <legend class="section-title" id="rules-label">Regras do estabelecimento</legend>

            <div formArrayName="rulesItems" role="list" aria-labelledby="rules-label">
              <div *ngFor="let item of rulesItems.controls; let i = index" [formGroupName]="i" class="checkbox-group" role="listitem">
                <label [for]="'rule-check-' + i" class="sr-only">
                  {{ item.get('checked')?.value ? 'Regra selecionada' : 'Selecionar regra' }}
                </label>
                <input 
                  type="checkbox" 
                  [id]="'rule-check-' + i"
                  formControlName="checked"
                  [attr.aria-describedby]="'rule-name-' + i"
                  [attr.aria-label]="'Selecionar regra: ' + (item.get('name')?.value || 'nova regra')" />

                <label [for]="'rule-name-' + i" class="sr-only">Texto da regra {{ i + 1 }}</label>
                <input 
                  type="text" 
                  [id]="'rule-name-' + i"
                  formControlName="name" 
                  placeholder="Digite a regra..."
                  [disabled]="item.get('checked')?.value" 
                  [class.input-active]="item.get('checked')?.value"
                  [attr.aria-label]="'Texto da regra ' + (i + 1)" />

                <button 
                  type="button" 
                  (click)="removeRuleItem(i)" 
                  class="btn-trash"
                  [attr.aria-label]="'Remover regra ' + (i + 1)">
                  <span aria-hidden="true">üóë</span>
                </button>
              </div>
            </div>

            <!-- container centralizado -->
            <div class="add-btn-container">
              <button 
                type="button" 
                (click)="addRuleItem()" 
                class="btn-add"
                aria-label="Adicionar nova regra do estabelecimento">
                + Adicionar regra
              </button>
            </div>
          </fieldset>
        </div>

        <div *ngIf="canShowDeliveryItemsRules()" class="form-group">
          <fieldset>
            <legend class="section-title" id="delivery-rules-label">Regras de entrega</legend>

            <div formArrayName="deliveryRulesItems" role="list" aria-labelledby="delivery-rules-label">
              <div *ngFor="let item of deliveryRulesItems.controls; let i = index" [formGroupName]="i"
                class="checkbox-group" role="listitem">
                <label [for]="'delivery-rule-check-' + i" class="sr-only">
                  {{ item.get('checked')?.value ? 'Regra de entrega selecionada' : 'Selecionar regra de entrega' }}
                </label>
                <input 
                  type="checkbox" 
                  [id]="'delivery-rule-check-' + i"
                  formControlName="checked"
                  [attr.aria-describedby]="'delivery-rule-name-' + i"
                  [attr.aria-label]="'Selecionar regra de entrega: ' + (item.get('name')?.value || 'nova regra')" />

                <label [for]="'delivery-rule-name-' + i" class="sr-only">Texto da regra de entrega {{ i + 1 }}</label>
                <input 
                  type="text" 
                  [id]="'delivery-rule-name-' + i"
                  formControlName="name" 
                  placeholder="Digite a regra de entrega..."
                  [disabled]="item.get('checked')?.value" 
                  [class.input-active]="item.get('checked')?.value"
                  [attr.aria-label]="'Texto da regra de entrega ' + (i + 1)" />

                <button 
                  type="button" 
                  (click)="removeDeliveryRuleItem(i)" 
                  class="btn-trash"
                  [attr.aria-label]="'Remover regra de entrega ' + (i + 1)">
                  <span aria-hidden="true">üóë</span>
                </button>
              </div>
            </div>

            <div class="add-btn-container">
              <button 
                type="button" 
                (click)="addDeliveryRuleItem()" 
                class="btn-add"
                aria-label="Adicionar nova regra de entrega">
                + Adicionar regra de entrega
              </button>
            </div>
          </fieldset>
        </div>


        <div class="form-group">
          <fieldset>
            <legend class="section-title" id="informational-label">Informa√ß√µes do estabelecimento</legend>

            <div formArrayName="informationalItems" class="cards-grid" role="group" aria-labelledby="informational-label">
              <div *ngFor="let item of informationalItems.controls; let i = index" [formGroupName]="i" class="card-item"
                [class.active]="item.get('checked')?.value"
                (click)="item.get('checked')?.setValue(!item.get('checked')?.value)"
                (keydown.enter)="item.get('checked')?.setValue(!item.get('checked')?.value); $event.preventDefault()"
                (keydown.space)="item.get('checked')?.setValue(!item.get('checked')?.value); $event.preventDefault()"
                tabindex="0"
                role="checkbox"
                [attr.aria-checked]="item.get('checked')?.value"
                [attr.aria-label]="item.get('name')?.value">
                <!-- Checkbox oculto -->
                <input type="checkbox" formControlName="checked" hidden tabindex="-1" />

                <!-- √çcone -->
                <div class="card-icon" aria-hidden="true">
                  <mat-icon class="text-4xl">{{ item.get('icon')?.value }}</mat-icon>
                </div>

                <!-- Texto -->
                <div class="card-text" aria-hidden="true">
                  {{ item.get('name')?.value }}
                </div>
              </div>
            </div>
          </fieldset>
        </div>
      </div>


      <!-- Bot√µes de Navega√ß√£o -->
      <div class="form-actions" role="navigation" aria-label="Navega√ß√£o do formul√°rio">
        <a 
          href="#" 
          (click)="goToPreviousStep(); $event.preventDefault()" 
          (keydown.enter)="goToPreviousStep(); $event.preventDefault()"
          class="btn-back"
          [attr.aria-label]="currentStep === 1 ? 'Voltar para p√°gina de login' : 'Voltar para etapa anterior'">
          Voltar
        </a>
        <button 
          type="submit" 
          class="btn-continue" 
          [disabled]="isLoading"
          [attr.aria-label]="isLoading ? 'Carregando...' : (currentStep === 5 ? 'Finalizar cadastro' : 'Continuar para pr√≥xima etapa')">
          <span *ngIf="!isLoading">{{ buttonText }}</span>
          <span *ngIf="isLoading" role="status" aria-live="polite">Carregando...</span>
        </button>
      </div>
    </form>
  </div>
</div>