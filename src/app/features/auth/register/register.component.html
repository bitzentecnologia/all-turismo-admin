<div class="registrar-container">
  <div class="registrar-card">
    <!-- Header com Logo -->
    <div class="registrar-header">
      <div class="logo">
        <img src="assets/images/logo/logo5.png" alt="ALLTURISMO" class="logo-image">
        <span class="logo-text">ALLTURISMO</span>
      </div>
      <div class="header-content">
        <h3 class="subtitle">SEJA UM PARCEIRO</h3>
        <h2 class="title">{{ stepTitle }}</h2>
      </div>
    </div>

    <!-- Barra de Progresso -->
    <div class="progress-bar">
      <div class="progress-step" [class.active]="currentStep >= 1" [class.completed]="currentStep > 1">
        <div class="step-number">
          <span *ngIf="currentStep > 1" class="check-icon">‚úì</span>
          <span *ngIf="currentStep === 1">1</span>
        </div>
        <span class="step-text">Respons√°vel</span>
      </div>
      <div class="progress-line" [class.completed]="currentStep > 1"></div>
      <div class="progress-step" [class.active]="currentStep >= 2" [class.completed]="currentStep > 2">
        <div class="step-number">
          <span *ngIf="currentStep > 2" class="check-icon">‚úì</span>
          <span *ngIf="currentStep <= 2">2</span>
        </div>
        <span class="step-text">Endere√ßo</span>
      </div>
      <div class="progress-line" [class.completed]="currentStep > 2"></div>
      <div class="progress-step" [class.active]="currentStep >= 3" [class.completed]="currentStep > 3">
        <div class="step-number">
          <span *ngIf="currentStep > 3" class="check-icon">‚úì</span>
          <span *ngIf="currentStep <= 3">3</span>
        </div>
        <span class="step-text">Estabelecimento</span>
      </div>
      <div class="progress-line" [class.completed]="currentStep > 3"></div>
      <div class="progress-step" [class.active]="currentStep >= 4" [class.completed]="currentStep > 4">
        <div class="step-number">
          <span *ngIf="currentStep > 4" class="check-icon">‚úì</span>
          <span *ngIf="currentStep <= 4">4</span>
        </div>
        <span class="step-text">Promo√ß√£o obrigat√≥ria</span>
      </div>
      <div class="progress-line" [class.completed]="currentStep > 4"></div>
      <div class="progress-step" [class.active]="currentStep >= 5" [class.completed]="currentStep > 5">
        <div class="step-number">
          <span *ngIf="currentStep > 5" class="check-icon">‚úì</span>
          <span *ngIf="currentStep <= 5">5</span>
        </div>
        <span class="step-text">Regras e informa√ß√µes</span>
      </div>
      <div class="progress-line" [class.completed]="currentStep > 5"></div>

    </div>

    <!-- Formul√°rio -->
    <form [formGroup]="registerForm" (ngSubmit)="nextStep()" class="registrar-form">

      <!-- Etapa 1: Dados do Respons√°vel -->
      <div *ngIf="isStep1" class="form-step" [formGroupName]="'responsible'">
        <div class="form-group">
          <label for="name">Nome</label>
          <input
            type="text"
            id="name"
            formControlName="name"
            placeholder="Digite seu nome completo"
            [class.error]="responsibleForm.get('name')?.invalid && responsibleForm.get('name')?.touched"
          >
          <div *ngIf="responsibleForm.get('name')?.invalid && responsibleForm.get('name')?.touched" class="error-message">
            <span *ngIf="responsibleForm.get('name')?.errors?.['required']">Nome √© obrigat√≥rio</span>
            <span *ngIf="responsibleForm.get('name')?.errors?.['minlength']">Nome deve ter pelo menos 2 caracteres</span>
          </div>
        </div>

        <div class="form-group">
          <label for="email">E-mail</label>
          <input
            type="email"
            id="email"
            formControlName="email"
            placeholder="Digite seu e-mail"
            [class.error]="responsibleForm.get('email')?.invalid && responsibleForm.get('email')?.touched"
          >
          <div *ngIf="responsibleForm.get('email')?.invalid && responsibleForm.get('email')?.touched" class="error-message">
            <span *ngIf="responsibleForm.get('email')?.errors?.['required']">E-mail √© obrigat√≥rio</span>
            <span *ngIf="responsibleForm.get('email')?.errors?.['email']">E-mail inv√°lido</span>
          </div>
        </div>

        <div class="form-group">
          <label for="password">Senha</label>
          <input
            type="password"
            id="password"
            formControlName="password"
            placeholder="Senha para acessar a plataforma"
            [class.error]="responsibleForm.get('password')?.invalid && responsibleForm.get('password')?.touched"
          >
          <div *ngIf="responsibleForm.get('password')?.invalid && responsibleForm.get('password')?.touched" class="error-message">
            <span *ngIf="responsibleForm.get('password')?.errors?.['required']">Senha √© obrigat√≥ria</span>
            <span *ngIf="responsibleForm.get('password')?.errors?.['minlength']">Senha deve ter pelo menos 6 caracteres</span>
          </div>
        </div>

        <div class="form-group">
          <label for="phone">WhatsApp</label>
          <input
            type="tel"
            id="phone"
            formControlName="phone"
            (input)="formatPhone($event)"
            (keypress)="validateNumbersOnly($event)"
            placeholder="(XX) XXXXX-XXXX"
            maxlength="15"
            [class.error]="responsibleForm.get('phone')?.invalid && responsibleForm.get('phone')?.touched"
          >
          <div *ngIf="responsibleForm.get('phone')?.invalid && responsibleForm.get('phone')?.touched" class="error-message">
            <span *ngIf="responsibleForm.get('phone')?.errors?.['required']">WhatsApp √© obrigat√≥rio</span>
            <span *ngIf="responsibleForm.get('phone')?.errors?.['minlength']">WhatsApp deve ter pelo menos 14 caracteres</span>
          </div>
        </div>
      </div>

      <!-- Etapa 2: Endere√ßo -->
      <div *ngIf="isStep2" class="form-step" [formGroupName]="'address'">
        <div class="form-group">
          <label for="cep">CEP</label>
          <div class="cep-input-container">
            <input
              type="text"
              id="cep"
              formControlName="cep"
              (input)="formatCep($event)"
              (keypress)="validateNumbersOnly($event)"
              placeholder="00000-000"
              maxlength="9"
              [class.error]="addressForm.get('cep')?.invalid && addressForm.get('cep')?.touched"
              [disabled]="isConsultingCep"
            >
            <div *ngIf="isConsultingCep" class="cep-loading">
              <span>Consultando...</span>
            </div>
          </div>
          <div *ngIf="addressForm.get('cep')?.invalid && addressForm.get('cep')?.touched" class="error-message">
            <span *ngIf="addressForm.get('cep')?.errors?.['required']">CEP √© obrigat√≥rio</span>
            <span *ngIf="addressForm.get('cep')?.errors?.['minlength']">CEP deve ter pelo menos 8 caracteres</span>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="state">Estado</label>
            <input
              type="text"
              id="state"
              formControlName="state"
              placeholder="Digite o estado"
              [class.error]="addressForm.get('state')?.invalid && addressForm.get('state')?.touched"
            >
            <div *ngIf="addressForm.get('state')?.invalid && addressForm.get('state')?.touched" class="error-message">
              <span *ngIf="addressForm.get('state')?.errors?.['required']">Estado √© obrigat√≥rio</span>
            </div>
          </div>

          <div class="form-group">
            <label for="city">Cidade</label>
            <input
              type="text"
              id="city"
              formControlName="city"
              placeholder="Digite a cidade"
              [class.error]="addressForm.get('city')?.invalid && addressForm.get('city')?.touched"
            >
            <div *ngIf="addressForm.get('city')?.invalid && addressForm.get('city')?.touched" class="error-message">
              <span *ngIf="addressForm.get('city')?.errors?.['required']">Cidade √© obrigat√≥ria</span>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label for="neighborhood">Bairro</label>
          <input
            type="text"
            id="neighborhood"
            formControlName="neighborhood"
            placeholder="Digite o bairro"
            [class.error]="addressForm.get('neighborhood')?.invalid && addressForm.get('neighborhood')?.touched"
          >
          <div *ngIf="addressForm.get('neighborhood')?.invalid && addressForm.get('neighborhood')?.touched" class="error-message">
            <span *ngIf="addressForm.get('neighborhood')?.errors?.['required']">Bairro √© obrigat√≥rio</span>
          </div>
        </div>

        <div class="form-group">
          <label for="street">Rua/Avenida</label>
          <input
            type="text"
            id="street"
            formControlName="street"
            placeholder="Digite a rua ou avenida"
            [class.error]="addressForm.get('street')?.invalid && addressForm.get('street')?.touched"
          >
          <div *ngIf="addressForm.get('street')?.invalid && addressForm.get('street')?.touched" class="error-message">
            <span *ngIf="addressForm.get('street')?.errors?.['required']">Rua/Avenida √© obrigat√≥ria</span>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="number">N√∫mero</label>
            <input
              type="text"
              id="number"
              formControlName="number"
              placeholder="Digite o n√∫mero"
              [class.error]="addressForm.get('number')?.invalid && addressForm.get('number')?.touched"
            >
            <div *ngIf="addressForm.get('number')?.invalid && addressForm.get('number')?.touched" class="error-message">
              <span *ngIf="addressForm.get('number')?.errors?.['required']">N√∫mero √© obrigat√≥rio</span>
            </div>
          </div>

          <div class="form-group">
            <label for="complement">Complemento (opcional)</label>
            <input
              type="text"
              id="complement"
              formControlName="complement"
              placeholder="Digite o complemento"
            >
          </div>
        </div>
      </div>

      <!-- Etapa 3: Estabelecimento -->
      <div *ngIf="isStep3" class="form-step" [formGroupName]="'establishment'">
        <div class="form-group">
          <label for="establishmentName">Nome do estabelecimento (como aparecer√° no app)</label>
          <input
            type="text"
            id="establishmentName"
            formControlName="name"
            placeholder="Ex.: Pizzaria Bela Massas"
            [class.error]="establishmentForm.get('name')?.invalid && establishmentForm.get('name')?.touched"
          >
          <div *ngIf="establishmentForm.get('name')?.invalid && establishmentForm.get('name')?.touched" class="error-message">
            <span *ngIf="establishmentForm.get('name')?.errors?.['required']">Nome do estabelecimento √© obrigat√≥rio</span>
            <span *ngIf="establishmentForm.get('name')?.errors?.['minlength']">Nome deve ter pelo menos 2 caracteres</span>
          </div>
        </div>

        <div class="form-group">
          <label for="cnpj">CNPJ</label>
          <input
            type="text"
            id="cnpj"
            formControlName="cnpj"
            (input)="formatCnpj($event)"
            (keypress)="validateNumbersOnly($event)"
            placeholder="00.000.000/0001-00"
            maxlength="18"
            [class.error]="establishmentForm.get('cnpj')?.invalid && establishmentForm.get('cnpj')?.touched"
          >
          <div *ngIf="establishmentForm.get('cnpj')?.invalid && establishmentForm.get('cnpj')?.touched" class="error-message">
            <span *ngIf="establishmentForm.get('cnpj')?.errors?.['required']">CNPJ √© obrigat√≥rio</span>
            <span *ngIf="establishmentForm.get('cnpj')?.errors?.['minlength']">CNPJ deve ter pelo menos 18 caracteres</span>
            <span *ngIf="establishmentForm.get('cnpj')?.errors?.['invalidCnpj']">CNPJ inv√°lido</span>
          </div>
        </div>

        <div class="category-grid">
          <div
            *ngFor="let category of categories"
            class="category-option"
            [class.selected]="establishmentForm.get('categoryId')?.value === category.id"
            (click)="establishmentForm.patchValue({categoryId: category.id}); onCategoryChange(category.id)"
          >
            <input
              type="radio"
              [id]="'category-' + category.id"
              name="categoryId"
              [value]="category.id"
              formControlName="categoryId"
            >
            <label [for]="'category-' + category.id">{{ category.name }}</label>
          </div>
        </div>

        <div *ngIf="establishmentForm.get('categoryId')?.invalid && establishmentForm.get('categoryId')?.touched" class="error-message">
          <span *ngIf="establishmentForm.get('categoryId')?.errors?.['required']">Categoria √© obrigat√≥ria</span>
        </div>

        <div class="form-group">
          <label for="subcategory">Subcategoria</label>
          <select
            id="subcategory"
            formControlName="subcategoryId"
            [disabled]="!establishmentForm.get('categoryId')?.value"
          >
            <option value="">Selecione uma subcategoria</option>
            <option
              *ngFor="let subcategory of subcategories"
              [value]="subcategory.id"
            >
              {{ subcategory.name }}
            </option>
          </select>
        </div>

        <div *ngIf="canShowDeliveryOption()" class="form-group mb-8">
          <p class="section-title mb-2">Servi√ßo de delivery</p>
          <label class="flex items-center space-x-3">
            <input
              type="checkbox"
              id="hasDelivery"
              formControlName="has_delivery"
              class="w-5 h-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
            />
            <span class="text-gray-700 font-medium">Oferece servi√ßo de delivery</span>
          </label>
        </div>

        <div class="form-group">
          <label class="section-title">Meios de contato</label>
          <p class="section-subtitle">Ficar√£o vis√≠veis em seu perfil no app.</p>

          <div class="form-group">
            <label for="establishmentPhone">Telefone/WhatsApp</label>
            <input
              type="tel"
              id="establishmentPhone"
              formControlName="phone"
              (input)="formatEstablishmentPhone($event)"
              (keypress)="validateNumbersOnly($event)"
              placeholder="(XX) XXXXX-XXXX"
              maxlength="15"
              [class.error]="establishmentForm.get('phone')?.invalid && establishmentForm.get('phone')?.touched"
            >
            <div *ngIf="establishmentForm.get('phone')?.invalid && establishmentForm.get('phone')?.touched" class="error-message">
              <span *ngIf="establishmentForm.get('phone')?.errors?.['required']">Telefone/WhatsApp √© obrigat√≥rio</span>
              <span *ngIf="establishmentForm.get('phone')?.errors?.['minlength']">Telefone deve ter pelo menos 14 caracteres</span>
            </div>
          </div>

          <div class="form-group">
            <label for="instagram">Instagram</label>
            <input
              type="url"
              id="instagram"
              formControlName="instagram"
              placeholder="Insira o link do seu perfil"
            >
          </div>
        </div>

        <div class="form-group">
          <label for="description">Descreva a atividade do estabelecimento</label>
          <textarea
            id="description"
            formControlName="description"
            placeholder="Ex.: Bar especializado em petiscos."
            maxlength="100"
            rows="4"
            [class.error]="establishmentForm.get('description')?.invalid && establishmentForm.get('description')?.touched"
          ></textarea>
          <div class="char-counter">{{ establishmentForm.get('description')?.value?.length || 0 }}/100</div>
          <div *ngIf="establishmentForm.get('description')?.invalid && establishmentForm.get('description')?.touched" class="error-message">
            <span *ngIf="establishmentForm.get('description')?.errors?.['maxlength']">Descri√ß√£o deve ter no m√°ximo 100 caracteres</span>
          </div>
        </div>

        <div class="form-group">
          <label class="section-title">Logo (Opcional)</label>
          <p class="section-subtitle">Envie a logo do seu estabelecimento.</p>

          <div class="logo-upload-area">
            <div class="upload-placeholder">
              <input
                type="file"
                id="logoFile"
                accept="image/*"
                (change)="onLogoSelected($event)"
                style="display: none;"
                #fileInput
              >
              <div class="upload-icon">‚Üë</div>
              <button
                type="button"
                class="upload-btn"
                (click)="fileInput.click()"
              >
                Selecionar imagem
              </button>
            </div>

            <div *ngIf="establishmentForm.get('logoPreview')?.value" class="logo-preview">
              <img [src]="establishmentForm.get('logoPreview')?.value" alt="Logo preview" class="preview-image">
              <button
                type="button"
                class="remove-btn"
                (click)="removeLogo()"
              >
                Remover
              </button>
            </div>

            <!-- Debug: Mostrar valor do logoPreview -->
            <div style="margin-top: 10px; font-size: 12px; color: #666;">
              Debug - logoPreview: {{ establishmentForm.get('logoPreview')?.value ? 'Tem valor' : 'Sem valor' }}
            </div>
          </div>
        </div>
      </div>

      <!-- Etapa 4: Promo√ß√£o obrigat√≥ria -->
      <div *ngIf="isStep4" class="form-step">
        <!-- Conte√∫do em branco para a etapa de promo√ß√£o -->
      </div>

      <!-- Etapa 5: Regras e Informa√ß√µes -->
      <div *ngIf="isStep5" class="form-step" [formGroupName]="'additionalInfo'">
        <div class="form-group">
          <label class="section-title">Regras do estabelecimento</label>

          <div formArrayName="rulesItems">
            <div
              *ngFor="let item of rulesItems.controls; let i = index"
              [formGroupName]="i"
              class="checkbox-group"
            >
              <input type="checkbox" formControlName="checked" />

              <input
                type="text"
                formControlName="name"
                placeholder="Digite a regra..."
                [disabled]="item.get('checked')?.value"
                [class.input-active]="item.get('checked')?.value"
              />

              <button type="button" (click)="removeRuleItem(i)" class="btn-trash">
                üóë
              </button>
            </div>
          </div>

          <!-- container centralizado -->
          <div class="add-btn-container">
            <button type="button" (click)="addRuleItem()" class="btn-add">
              + Adicionar regra
            </button>
          </div>
        </div>

        <div *ngIf="canShowDeliveryItemsRules()" class="form-group">
          <label class="section-title">Regras de entrega</label>

          <div formArrayName="deliveryRulesItems">
            <div
              *ngFor="let item of deliveryRulesItems.controls; let i = index"
              [formGroupName]="i"
              class="checkbox-group"
            >
              <input type="checkbox" formControlName="checked" />

              <input
                type="text"
                formControlName="name"
                placeholder="Digite a regra de entrega..."
                [disabled]="item.get('checked')?.value"
                [class.input-active]="item.get('checked')?.value"
              />

              <button type="button" (click)="removeDeliveryRuleItem(i)" class="btn-trash">
                üóë
              </button>
            </div>
          </div>

          <div class="add-btn-container">
            <button type="button" (click)="addDeliveryRuleItem()" class="btn-add">
              + Adicionar regra de entrega
            </button>
          </div>
        </div>


        <div class="form-group">
          <label class="section-title">Informa√ß√µes do estabelecimento</label>

          <div formArrayName="informationalItems" class="cards-grid">
            <div
              *ngFor="let item of informationalItems.controls; let i = index"
              [formGroupName]="i"
              class="card-item"
              [class.active]="item.get('checked')?.value"
              (click)="item.get('checked')?.setValue(!item.get('checked')?.value)"
            >
              <!-- Checkbox oculto -->
              <input type="checkbox" formControlName="checked" hidden />

              <!-- √çcone -->
              <div class="card-icon">
                <mat-icon class="text-4xl">{{ item.get('icon')?.value }}</mat-icon>
              </div>

              <!-- Texto -->
              <div class="card-text">
                {{ item.get('name')?.value }}
              </div>
            </div>
          </div>
        </div>
      </div>


      <!-- Bot√µes de Navega√ß√£o -->
      <div class="form-actions">
        <a href="#" (click)="previousStep(); $event.preventDefault()" class="btn-back">
          Voltar
        </a>
        <button
          type="submit"
          class="btn-continue"
          [disabled]="isLoading"
        >
          <span *ngIf="!isLoading">{{ buttonText }}</span>
          <span *ngIf="isLoading">Carregando...</span>
        </button>
      </div>
    </form>
  </div>
</div>
