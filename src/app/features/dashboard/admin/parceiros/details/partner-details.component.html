<div class="partner-details-page">
  <!-- Loading -->
  <div *ngIf="loading" class="loading-container">
    <span class="loading-spinner"></span> Carregando parceiro...
  </div>

  <!-- Detalhes do parceiro -->
  <div *ngIf="!loading && partner" class="details-container">
    <div class="partner-header">
      <button class="btn-back" (click)="goBack()">
        <mat-icon>arrow_back</mat-icon>
      </button>

      <img [src]="imageService.getImageById(partner.logo_url)" alt="Logo do parceiro" class="logo" />

      <h1 class="partner-name">{{ partner.name }}</h1>
    </div>

    <!-- Accordion -->
    <div class="accordion">
      <!-- Informações gerais -->
      <div class="accordion-item">
        <button class="accordion-header" (click)="toggleSection('info')">
          <span class="section-title">
            <mat-icon>info</mat-icon>
            Informações gerais
          </span>
          <span class="chevron" [class.open]="openSection === 'info'">⌄</span>
        </button>
        <div class="accordion-body" [class.open]="openSection === 'info'">
          <!-- Row 1: Nome (largura completa) -->
          <div class="field-row full-width">
            <label>Nome</label>
            <input type="text" [(ngModel)]="partner.name" required maxlength="100" placeholder="Nome da empresa" />
          </div>

          <!-- Linha 2: Status e CNPJ lado a lado -->
          <div class="field-row two-columns">
            <div class="field-group">
              <label>Status</label>
              <div class="status-row">
                <select [(ngModel)]="partner.status" [disabled]="approving">
                  <option value="ACTIVE">Ativo</option>
                  <option value="INACTIVE">Inativo</option>
                  <option value="PENDING">Pendente</option>
                </select>

                <button *ngIf="partner.status === 'PENDING'" class="btn-approve" (click)="approvePartner()"
                  [disabled]="approving">
                  <span *ngIf="!approving">Aprovar</span>
                  <span *ngIf="approving" class="loading-spinner-small"></span>
                </button>
              </div>
            </div>
            <div class="field-group">
              <label>CNPJ</label>
              <input type="text" [(ngModel)]="partner.cnpj" (input)="onCnpjInput($event)"
                placeholder="00.000.000/0000-00" maxlength="18" />
            </div>
          </div>

          <!-- Linha 3: Telefone e Instagram lado a lado -->
          <div class="field-row two-columns">
            <div class="field-group">
              <label>Telefone</label>
              <input type="text" [(ngModel)]="partner.contact_phone" (input)="onPhoneInput($event)"
                placeholder="(11) 99999-9999" maxlength="15" />
            </div>
            <div class="field-group">
              <label *ngIf="partner.instagram !== undefined">Instagram</label>
              <input *ngIf="partner.instagram !== undefined" type="url" [(ngModel)]="partner.instagram"
                placeholder="https://instagram.com/usuario" />
            </div>
          </div>

          <!-- Linha 4: Descrição e Promoção lado a lado (3 linhas de altura) -->
          <div class="field-row two-columns">
            <div class="field-group" *ngIf="partner.description !== undefined">
              <label>Descrição</label>
              <textarea rows="3" [(ngModel)]="partner.description" maxlength="500"
                placeholder="Descrição da empresa"></textarea>
            </div>
            <div class="field-group">
              <label>Promoção</label>
              <textarea rows="3" [(ngModel)]="partner.promotion" placeholder="Digite a promoção..."
                maxlength="1000"></textarea>
            </div>
          </div>

          <!-- Se não houver descrição, promoção ocupa linha inteira -->
          <div class="field-row full-width" *ngIf="partner.description === undefined">
            <label>Promoção</label>
            <textarea rows="3" [(ngModel)]="partner.promotion" placeholder="Digite a promoção..."
              maxlength="1000"></textarea>
          </div>

        </div>
      </div>

      <!-- Endereço -->
      <div class="accordion-item" *ngIf="partner.address">
        <button class="accordion-header" (click)="toggleSection('address')">
          <span class="section-title">
            <mat-icon>location_on</mat-icon>
            Endereço
          </span>
          <span class="chevron" [class.open]="openSection === 'address'">⌄</span>
        </button>
        <div class="accordion-body" [class.open]="openSection === 'address'">
          <!-- Row 1: Rua (largura completa) -->
          <div class="field-row full-width">
            <label>Rua</label>
            <input type="text" [(ngModel)]="partner.address.street" />
          </div>

          <!-- Row 2: Número e Complemento lado a lado -->
          <div class="field-row two-columns">
            <div class="field-group">
              <label>Número</label>
              <input type="text" [(ngModel)]="partner.address.number" />
            </div>
            <div class="field-group">
              <label>Complemento</label>
              <input type="text" [(ngModel)]="partner.address.complement" />
            </div>
          </div>

          <!-- Row 3: Bairro e CEP lado a lado -->
          <div class="field-row two-columns">
            <div class="field-group">
              <label>Bairro</label>
              <input type="text" [(ngModel)]="partner.address.neighborhood" />
            </div>
            <div class="field-group">
              <label>CEP</label>
              <input type="text" [(ngModel)]="partner.address.zip_code" (input)="onCepInput($event)"
                placeholder="00000-000" maxlength="9" />
            </div>
          </div>

          <!-- Row 4: Cidade e Estado lado a lado -->
          <div class="field-row two-columns">
            <div class="field-group">
              <label>Cidade</label>
              <input type="text" [(ngModel)]="partner.address.city" />
            </div>
            <div class="field-group">
              <label>Estado</label>
              <input type="text" [(ngModel)]="partner.address.state" />
            </div>
          </div>
        </div>
      </div>

      <!-- Categoria -->
      <div class="accordion-item" *ngIf="partner.category">
        <button class="accordion-header" (click)="toggleSection('category')">
          <span class="section-title">
            <mat-icon>category</mat-icon>
            Categoria
          </span>
          <span class="chevron" [class.open]="openSection === 'category'">⌄</span>
        </button>
        <div class="accordion-body" [class.open]="openSection === 'category'">
          <div class="field-row two-columns">
            <div class="field-group">
              <label>Categoria</label>
              <input disabled type="text" [(ngModel)]="partner.category.name" />
            </div>
            <div class="field-group">
              <label>Sub categoria</label>
              <input disabled type="text" [(ngModel)]="partner.subcategory.name" />
            </div>
          </div>
        </div>
      </div>

      <!-- Fotos -->
      <div class="accordion-item" *ngIf="partner.photos?.length">
        <button class="accordion-header" (click)="toggleSection('photos')">
          <span class="section-title">
            <mat-icon>photo_library</mat-icon>
            Fotos
          </span>
          <span class="chevron" [class.open]="openSection === 'photos'">⌄</span>
        </button>
        <div class="accordion-body" [class.open]="openSection === 'photos'">
          <div class="photos-grid">
            <div *ngFor="let photo of partner.photos" class="photo-item">
              <img [src]="imageService.getImageById(photo)" alt="Foto do estabelecimento" />
            </div>
          </div>
        </div>
      </div>

      <!-- Regras da categoria -->
      <div class="accordion-item">
        <button class="accordion-header" (click)="toggleSection('rules')">
          <span class="section-title">
            <mat-icon>rule</mat-icon>
            Regras
          </span>
          <span class="chevron" [class.open]="openSection === 'rules'">⌄</span>
        </button>
        <div class="accordion-body" [class.open]="openSection === 'rules'">
          <div class="rules-list">
            <div *ngFor="let rule of partnerRules; let i = index" class="rule-item">
              <div class="rule-row">
                <input type="text" [(ngModel)]="rule.text" class="rule-input" placeholder="Digite uma regra..." />
                <button type="button" class="btn-delete" (click)="removeRule(i)" title="Excluir regra">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
            </div>
            <button type="button" class="btn-add-rule" (click)="addRule()">
              <mat-icon>add</mat-icon>
              Adicionar Regra
            </button>
          </div>
        </div>
      </div>

      <!-- Regras da categoria para delivery -->
      <div class="accordion-item" *ngIf="partner.has_delivery">
        <button class="accordion-header" (click)="toggleSection('deliveryRules')">
          <span class="section-title">
            <mat-icon>delivery_dining</mat-icon>
            Regras de delivery
          </span>
          <span class="chevron" [class.open]="openSection === 'deliveryRules'">⌄</span>
        </button>
        <div class="accordion-body" [class.open]="openSection === 'deliveryRules'">
          <div class="rules-list">
            <div *ngFor="let rule of partnerDeliveryRules; let i = index" class="rule-item">
              <div class="rule-row">
                <input type="text" [(ngModel)]="rule.text" class="rule-input"
                  placeholder="Digite uma regra de delivery..." />
                <button type="button" class="btn-delete" (click)="removeDeliveryRule(i)"
                  title="Excluir regra de delivery">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
            </div>
            <button type="button" class="btn-add-rule" (click)="addDeliveryRule()">
              <mat-icon>add</mat-icon>
              Adicionar Regra de Delivery
            </button>
          </div>
        </div>
      </div>

      <!-- Informações da categoria -->
      <div class="accordion-item" *ngIf="partnerCategoryInformationals?.length">
        <button class="accordion-header" (click)="toggleSection('infoals')">
          <span class="section-title">
            <mat-icon>description</mat-icon>
            Informações
          </span>
          <span class="chevron" [class.open]="openSection === 'infoals'">⌄</span>
        </button>
        <div class="accordion-body" [class.open]="openSection === 'infoals'">
          <div *ngFor="let info of partnerCategoryInformationals" class="info-item">
            <div class="info-row">
              <mat-icon>{{ info.icon }}</mat-icon>
              <textarea disabled rows="1" [(ngModel)]="info.text"></textarea>
            </div>
          </div>
        </div>
      </div>

      <!-- Horários de Funcionamento -->
      <div class="accordion-item" *ngIf="partner.operating_hours">
        <button class="accordion-header" (click)="toggleSection('hours')">
          <span class="section-title">
            <mat-icon>schedule</mat-icon>
            Horários de Funcionamento
          </span>
          <span class="chevron" [class.open]="openSection === 'hours'">⌄</span>
        </button>
        <div class="accordion-body" [class.open]="openSection === 'hours'">
          <table class="hours-table">
            <thead>
              <tr>
                <th>Dia</th>
                <th>Abertura</th>
                <th>Fechamento</th>
                <th>Fechado</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let day of getDaysOfWeek()">
                <td class="day-cell">{{ getDayName(day) }}</td>
                <td class="time-cell">
                  <input type="time" [(ngModel)]="partner.operating_hours[day].startTime" class="time-input" />
                </td>
                <td class="time-cell">
                  <input type="time" [(ngModel)]="partner.operating_hours[day].endTime" class="time-input" />
                </td>
                <td class="checkbox-cell">
                  <label class="closed-checkbox">
                    <input type="checkbox" [(ngModel)]="partner.operating_hours[day].isClosed" />
                    <span>Fechado</span>
                  </label>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Usuários -->
      <div class="accordion-item" *ngIf="partner.users?.length">
        <button class="accordion-header" (click)="toggleSection('users')">
          <span class="section-title">
            <mat-icon>people</mat-icon>
            Usuários
          </span>
          <span class="chevron" [class.open]="openSection === 'users'">⌄</span>
        </button>
        <div class="accordion-body" [class.open]="openSection === 'users'">
          <table class="users-table">
            <thead>
              <tr>
                <th>Nome</th>
                <th>Email</th>
                <th>WhatsApp</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let user of partner.users">
                <td class="name-cell">{{ user.name }}</td>
                <td class="email-cell">
                  <a [href]="'mailto:' + user.email" class="email-link">{{ user.email }}</a>
                </td>
                <td class="whatsapp-cell">
                  <a *ngIf="user.phone_whatsapp" [href]="'https://wa.me/55' + cleanPhoneNumber(user.phone_whatsapp)"
                    target="_blank" class="whatsapp-link">
                    {{ user.phone_whatsapp }}
                  </a>
                  <span *ngIf="!user.phone_whatsapp" class="no-phone">-</span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Botão Salvar -->
    <div *ngIf="!loading && partner" class="actions">
      <button class="btn-save" (click)="savePartner()">Salvar alterações</button>
    </div>
  </div>
</div>